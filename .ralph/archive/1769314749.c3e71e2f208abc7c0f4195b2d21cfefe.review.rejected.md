# Review: Fix Race Condition and Timeout Error Handler Feature

**Status:** ❌ REJECTED

## Summary

The original prompt requested **two fixes** for the netaio library:

1. **Fix 1**: Race Condition in TCPClient.request()
2. **Fix 2**: Timeout Error Handler Feature (spanning Tasks 1, 2, 4, 5, 6, 7)

Only **Fix 1** is complete. **Fix 2** is partially implemented with critical issues.

## Completed Work

### Task 1: TimeoutErrorHandler Type Definition ✅
**Status:** Complete (from previous commit `3be232e`)

The `TimeoutErrorHandler` type is correctly defined in `netaio/common.py` at lines 724-727:
```python
TimeoutErrorHandler = Callable[
    [NetworkNodeProtocol, str, tuple[str, int] | None, TimeoutError, dict[str, Any]],
    Awaitable[None] | None
]
```

### Task 3: Race Condition Fix ✅
**Status:** Complete (from previous commit `d90ab71`)

The race condition fix in `TCPClient.receive_loop()` is correctly implemented:
- Added `_receive_loop_task: asyncio.Task | None` class attribute
- `receive_loop()` sets task at start and clears in finally block
- `request()` uses `was_running` pattern to prevent duplicate tasks
- All 28 tests pass

## Incomplete Work

### Task 2: Fix Type Hints for keys_extractor ❌
**Status:** NOT STARTED

The type hints for `keys_extractor` must accept `tuple[str, int] | None` as second parameter:
- `netaio/common.py` line 239 (NetworkNodeProtocol.extract_keys property)
- `netaio/client.py` line 43 (class attribute) and line 58 (`__init__` param)
- `netaio/node.py` line 53 (class attribute) and line 75 (`__init__` param)

**None of these have been updated.**

### Task 4: TCPClient Timeout Handler Infrastructure ⚠️
**Status:** PARTIALLY COMPLETE - CRITICAL BUG

The infrastructure is mostly implemented but has a critical design flaw:

**What's Done:**
- ✅ Import `TimeoutErrorHandler` from common
- ✅ Add `timeout_error_handler` parameter to `__init__`
- ✅ Initialize `_timeout_error_handler`, `_timeout_handler_tasks`, `_timeout_handler_lock`
- ✅ Implement `set_timeout_handler()` method
- ✅ Implement `_invoke_timeout_handler()` method
- ✅ Implement `cancel_timeout_handler_tasks()` method

**Critical Bug:**
The timeout handler is invoked in unreachable code in `netaio/client.py:328-346`:

```python
if not len(result):  # THIS IS UNREACHABLE
    error = TimeoutError(...)
    context = {...}
    await self._invoke_timeout_handler(...)  # NEVER CALLED
    raise error
```

The issue is that `await asyncio.wait_for(event.wait(), timeout=timeout)` (line 318) raises `asyncio.TimeoutError` when timeout expires, which propagates out of the `try/finally` block and never reaches the timeout handler code.

**Result:** The timeout handler is **never invoked** when a timeout occurs.

### Task 5: AutoReconnectTimeoutHandler ❌
**Status:** NOT DONE

The `AutoReconnectTimeoutHandler` class should be at the bottom of `netaio/client.py` but does not exist. This is a bundled handler that auto-reconnects on timeout.

### Task 6: UDPNode Timeout Handler Infrastructure ❌
**Status:** NOT DONE

UDPNode needs the same timeout handler infrastructure as TCPClient:
- Import `TimeoutErrorHandler` from common
- Add `timeout_error_handler` parameter to `__init__`
- Initialize `_timeout_error_handler`, `_timeout_handler_tasks`, `_timeout_handler_lock`
- Implement `set_timeout_handler()`, `_invoke_timeout_handler()`, `cancel_timeout_handler_tasks()`
- Call `_invoke_timeout_handler()` before raising `TimeoutError` in `request()`

**None of these changes have been made to `netaio/node.py`.**

### Task 7: Update Module Exports ❌
**Status:** NOT DONE

The following should be exported from `netaio/__init__.py`:
- `TimeoutErrorHandler`
- `AutoReconnectTimeoutHandler`

**Neither is currently exported.**

## Test Results

All 28 tests pass, but this is misleading because:
1. The timeout handler code is unreachable, so no tests exercise it
2. The incomplete features (Tasks 2, 5, 6, 7) would break existing functionality if implemented

## Action Items

### Critical Fix Required:
1. **Fix Task 4 timeout handler invocation** in `netaio/client.py`:
   - Wrap `await asyncio.wait_for(event.wait(), timeout=timeout)` in a try/except block
   - Catch `asyncio.TimeoutError`
   - Convert to `TimeoutError` and call `_invoke_timeout_handler()` before raising
   - Example:
     ```python
     try:
         await asyncio.wait_for(event.wait(), timeout=timeout)
     except asyncio.TimeoutError:
         error = TimeoutError(...)
         context = {...}
         await self._invoke_timeout_handler(...)
         raise error
     ```

### Missing Implementation:
2. **Complete Task 2**: Update all `keys_extractor` type hints to accept `tuple[str, int] | None`
3. **Implement Task 5**: Add `AutoReconnectTimeoutHandler` class to bottom of `netaio/client.py`
4. **Implement Task 6**: Add timeout handler infrastructure to `netaio/node.py` (same as TCPClient)
5. **Complete Task 7**: Export `TimeoutErrorHandler` and `AutoReconnectTimeoutHandler` from `netaio/__init__.py`

## Recommendation

**REJECTED** - The task is incomplete and contains a critical bug that makes the timeout handler non-functional.

### Next Steps:
1. Fix the timeout handler invocation bug in Task 4
2. Complete Tasks 2, 5, 6, 7 as specified in the original prompt
3. Add tests for timeout handler functionality
4. Re-submit for review
